// main.js - UI glue for index.html, menggunakan webrtc.js

const el = (id)=>document.getElementById(id);
const roomInput = el("room-input");
const createBtn = el("create-room-btn");
const joinBtn = el("join-room-btn");
const mainScreen = el("main-screen");
const vcScreen = el("vc-screen");
const roomDisplay = el("room-code-display");
const leaveBtn = el("leave-btn");
const muteBtn = el("mute-btn");
const camBtn = el("cam-btn");
const localVideo = el("localVideo");
const remotesDiv = el("remotes");
const statusDiv = el("status");

let clientId = null;
let roomCode = null;
let manager = null;
let muted = false;
let camOff = false;

function showStatus(s){
  statusDiv.textContent = s;
}

createBtn.addEventListener("click", ()=>{
  const code = window.VC.randString(Math.floor(Math.random()*3)+6);
  enterRoom(code);
});

joinBtn.addEventListener("click", ()=>{
  const v = roomInput.value.trim();
  if(!v){ showStatus("Masukkan kode ruangan atau buat baru."); return; }
  enterRoom(v);
});

function enterRoom(code){
  roomCode = code;
  clientId = "u_"+window.VC.randString(6);
  // ensure room exists
  window.VC.ensureRoom(roomCode);
  // toggle screens
  mainScreen.classList.add("hidden");
  vcScreen.classList.remove("hidden");
  roomDisplay.textContent = roomCode;
  // start VC manager
  manager = new window.VC.VCManager({
    roomCode,
    clientId,
    onLocalStream: (stream) => {
      localVideo.srcObject = stream;
    },
    onRemoteStream: (remoteId, stream) => {
      // add or remove video element
      const id = "remote_"+remoteId;
      if(!stream){
        const el = document.getElementById(id);
        if(el) el.remove();
        return;
      }
      let box = document.getElementById(id);
      if(!box){
        box = document.createElement("div");
        box.className = "remote-box";
        box.id = id;
        const v = document.createElement("video");
        v.autoplay = true;
        v.playsInline = true;
        v.id = id+"_vid";
        v.controls = false;
        box.appendChild(v);
        remotesDiv.appendChild(box);
      }
      document.getElementById(id+"_vid").srcObject = stream;
    },
    onStatus: (s) => {
      if(s === "media-error") showStatus("Tidak dapat akses kamera/mik. Izinkan perangkat.");
      else if(s === "joined") showStatus("Berhasil masuk ruangan. Menunggu/terhubung dengan user lain.");
      else if(s.startsWith("left")) {
        showStatus("Anda keluar dari ruangan.");
        // back to main screen
        setTimeout(()=>resetToMain(), 600);
      } else if(s === "room-deleted") {
        alert("Ruangan telah dihapus oleh admin.");
        resetToMain();
      } else showStatus(s);
    }
  });
}

leaveBtn.addEventListener("click", ()=>{
  if(manager) manager.closeAll("user");
  else resetToMain();
});

muteBtn.addEventListener("click", ()=>{
  muted = !muted;
  if(manager) manager.mute(muted);
  muteBtn.textContent = muted ? "Unmute" : "Mute";
});

camBtn.addEventListener("click", ()=>{
  camOff = !camOff;
  if(manager) manager.cam(camOff);
  camBtn.textContent = camOff ? "Camera On" : "Camera Off";
});

function resetToMain(){
  // clear UI
  if(manager) {
    try{ manager.closeAll("reset"); }catch(e){}
    manager = null;
  }
  remotesDiv.innerHTML = "";
  localVideo.srcObject = null;
  roomDisplay.textContent = "";
  roomInput.value = "";
  mainScreen.classList.remove("hidden");
  vcScreen.classList.add("hidden");
  showStatus("");
}